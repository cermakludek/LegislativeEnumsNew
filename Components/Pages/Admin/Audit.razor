@page "/admin/audit"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using LegislativeEnumsNew.Data
@using LegislativeEnumsNew.Data.Entities
@using LegislativeEnumsNew.Resources
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@inject ApplicationDbContext DbContext
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["audit.title"]</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-journal-text me-2"></i>
        @L["audit.title"]
    </h1>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-1"></i> @L["common.filter"]
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">@L["audit.search"]</label>
                <input type="text" class="form-control" placeholder="@L["audit.searchPlaceholder"]"
                       @bind="searchText" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["audit.entityType"]</label>
                <select class="form-select" @bind="filterEntityType">
                    <option value="">@L["common.all"]</option>
                    @foreach (var entityType in entityTypes)
                    {
                        <option value="@entityType">@entityType</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["audit.changeType"]</label>
                <select class="form-select" @bind="filterChangeType">
                    <option value="">@L["common.all"]</option>
                    <option value="Create">@L["notification.action.insert"]</option>
                    <option value="Update">@L["notification.action.update"]</option>
                    <option value="Delete">@L["notification.action.delete"]</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["common.validFrom"]</label>
                <input type="date" class="form-control" @bind="filterDateFrom" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["common.validTo"]</label>
                <input type="date" class="form-control" @bind="filterDateTo" />
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary me-2" @onclick="ApplyFilters">
                <i class="bi bi-search me-1"></i> @L["common.search"]
            </button>
            <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                <i class="bi bi-x-lg me-1"></i> @L["common.cancel"]
            </button>
        </div>
    </div>
</div>

@if (audits == null)
{
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@L["common.loading"]</span>
        </div>
    </div>
}
else if (!audits.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        @L["audit.noRecords"]
    </div>
}
else
{
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>@totalCount</span>
            <span class="text-muted">@audits.Count</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>@L["admin.dashboard.time"]</th>
                        <th>@L["audit.changeType"]</th>
                        <th>@L["audit.entityType"]</th>
                        <th>@L["audit.entityCode"]</th>
                        <th>@L["audit.changedBy"]</th>
                        <th class="text-end">@L["common.actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var audit in audits)
                    {
                        <tr>
                            <td>@audit.ChangedAt.ToString("dd.MM.yyyy HH:mm:ss")</td>
                            <td>
                                <span class="badge @GetChangeTypeBadgeClass(audit.ChangeType)">@GetChangeTypeLabel(audit.ChangeType)</span>
                            </td>
                            <td>@audit.EntityType</td>
                            <td><code>@audit.EntityCode</code></td>
                            <td>@audit.ChangedBy</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowDetails(audit)" title="@L["common.detail"]">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (hasMoreRecords)
        {
            <div class="card-footer text-center">
                <button class="btn btn-outline-primary" @onclick="LoadMore">
                    <i class="bi bi-arrow-down-circle me-1"></i> @L["common.viewAll"]
                </button>
            </div>
        }
    </div>
}

@if (selectedAudit != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseDetails">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="badge @GetChangeTypeBadgeClass(selectedAudit.ChangeType) me-2">@GetChangeTypeLabel(selectedAudit.ChangeType)</span>
                        @selectedAudit.EntityType - @selectedAudit.EntityCode
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>@L["audit.entityId"]:</strong> @selectedAudit.Id
                        </div>
                        <div class="col-md-4">
                            <strong>@L["audit.changedBy"]:</strong> @selectedAudit.ChangedBy
                        </div>
                        <div class="col-md-4">
                            <strong>@L["audit.changedAt"]:</strong> @selectedAudit.ChangedAt.ToString("dd.MM.yyyy HH:mm:ss")
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>@L["audit.entityType"]:</strong> @selectedAudit.EntityType
                        </div>
                        <div class="col-md-4">
                            <strong>@L["audit.entityId"]:</strong> @selectedAudit.EntityId
                        </div>
                        <div class="col-md-4">
                            <strong>@L["audit.entityCode"]:</strong> <code>@selectedAudit.EntityCode</code>
                        </div>
                    </div>
                    <hr />
                    @if (!string.IsNullOrEmpty(selectedAudit.OldValues))
                    {
                        <h6><i class="bi bi-box-arrow-left me-1"></i> @L["audit.oldValues"]:</h6>
                        <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>@FormatJson(selectedAudit.OldValues)</code></pre>
                    }
                    @if (!string.IsNullOrEmpty(selectedAudit.NewValues))
                    {
                        <h6><i class="bi bi-box-arrow-right me-1"></i> @L["audit.newValues"]:</h6>
                        <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>@FormatJson(selectedAudit.NewValues)</code></pre>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetails">
                        <i class="bi bi-x-lg me-1"></i> @L["common.close"]
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<AuditLog>? audits;
    private AuditLog? selectedAudit;
    private List<string> entityTypes = new();
    private int totalCount;
    private bool hasMoreRecords;
    private int pageSize = 50;
    private int currentPage = 0;

    private string searchText = "";
    private string filterEntityType = "";
    private string filterChangeType = "";
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;

    protected override async Task OnInitializedAsync()
    {
        entityTypes = await DbContext.AuditLogs
            .Select(a => a.EntityType)
            .Distinct()
            .OrderBy(e => e)
            .ToListAsync();

        await LoadData();
    }

    private async Task LoadData()
    {
        currentPage = 0;
        var query = BuildQuery();
        totalCount = await query.CountAsync();
        audits = await query
            .OrderByDescending(a => a.ChangedAt)
            .Take(pageSize)
            .ToListAsync();
        hasMoreRecords = totalCount > audits.Count;
    }

    private async Task LoadMore()
    {
        currentPage++;
        var query = BuildQuery();
        var moreAudits = await query
            .OrderByDescending(a => a.ChangedAt)
            .Skip(currentPage * pageSize)
            .Take(pageSize)
            .ToListAsync();
        audits!.AddRange(moreAudits);
        hasMoreRecords = audits.Count < totalCount;
    }

    private IQueryable<AuditLog> BuildQuery()
    {
        var query = DbContext.AuditLogs.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.ToLower();
            query = query.Where(a =>
                a.EntityCode.ToLower().Contains(search) ||
                a.ChangedBy.ToLower().Contains(search) ||
                a.EntityType.ToLower().Contains(search) ||
                (a.OldValues != null && a.OldValues.ToLower().Contains(search)) ||
                (a.NewValues != null && a.NewValues.ToLower().Contains(search)));
        }

        if (!string.IsNullOrEmpty(filterEntityType))
        {
            query = query.Where(a => a.EntityType == filterEntityType);
        }

        if (!string.IsNullOrEmpty(filterChangeType) && Enum.TryParse<ChangeType>(filterChangeType, out var changeType))
        {
            query = query.Where(a => a.ChangeType == changeType);
        }

        if (filterDateFrom.HasValue)
        {
            query = query.Where(a => a.ChangedAt >= filterDateFrom.Value);
        }

        if (filterDateTo.HasValue)
        {
            var endDate = filterDateTo.Value.AddDays(1);
            query = query.Where(a => a.ChangedAt < endDate);
        }

        return query;
    }

    private async Task ApplyFilters()
    {
        await LoadData();
    }

    private async Task ClearFilters()
    {
        searchText = "";
        filterEntityType = "";
        filterChangeType = "";
        filterDateFrom = null;
        filterDateTo = null;
        await LoadData();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ApplyFilters();
        }
    }

    private string GetChangeTypeBadgeClass(ChangeType changeType) => changeType switch
    {
        ChangeType.Create => "bg-success",
        ChangeType.Update => "bg-info",
        ChangeType.Delete => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetChangeTypeLabel(ChangeType changeType) => changeType switch
    {
        ChangeType.Create => L["notification.action.insert"],
        ChangeType.Update => L["notification.action.update"],
        ChangeType.Delete => L["notification.action.delete"],
        _ => changeType.ToString()
    };

    private void ShowDetails(AuditLog audit)
    {
        selectedAudit = audit;
    }

    private void CloseDetails()
    {
        selectedAudit = null;
    }

    private string FormatJson(string json)
    {
        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            });
        }
        catch
        {
            return json;
        }
    }
}
